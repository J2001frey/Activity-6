<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Scan Contour View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Hide the loading spinner by default */
        #loading {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div>
            <h1>CT Scan Images</h1>
        </div>
        <div class="slider">
            <label for="binCount">Bin Count: <span id="binCountValue">10</span></label>
            <input type="range" id="binCount" min="2" max="20" value="10" Step="1" />

            <label for="minThreshold">Min Threshold: <span id="minThresholdValue">0</span></label>
            <input type="range" id="minThreshold" min="0" max="100" value="0" />

            <label for="maxThreshold">Max Threshold: <span id="maxThresholdValue">300</span></label>
            <input type="range" id="maxThreshold" min="0" max="1000" value="300" />
        </div>

        <hr />
        <div id="loading">
            <div class="spinner"></div>
            Loading...
        </div>
        <div class="main">
            <div id="files_container">
                <select id="files" name="file" size="10" multiple="multiple"></select>
            </div>
            <div class="canvas">
                <svg viewBox="-5 -10 270 270"></svg>
            </div>
        </div>
    </div>

    <script>

        const svg = d3.select("svg");
        const path = d3.geoPath();
        let currentBinCount = document.querySelector("#binCount").value;
        let currentMin = document.querySelector("#minThreshold").value;
        let currentMax = document.querySelector("#maxThreshold").value;

        // Initial display of slider values
        document.getElementById("binCountValue").textContent = currentBinCount;
        document.getElementById("minThresholdValue").textContent = currentMin;
        document.getElementById("maxThresholdValue").textContent = currentMax;

        let minValue, maxValue; // Variables for data extent

        function plot_contour(fileNumber) {
            d3.select("svg").selectAll("*").remove();

            // Step 1: Read JSON file
            d3.json("dicomData/" + fileNumber).then(data => {

                let m = 256, n = 256;
                // Convert 2D array data into 1D list
                let values_density = [];
                data.forEach(col => { col.forEach(d => values_density.push(+d)) });

                const min_max = d3.extent(values_density, d => d);
                minValue = min_max[0];
                maxValue = min_max[1];

                // Update slider range based on data extent
                document.querySelector("#minThreshold").min = minValue;
                document.querySelector("#minThreshold").max = maxValue;
                document.querySelector("#maxThreshold").min = minValue;
                document.querySelector("#maxThreshold").max = maxValue;

                // Recalculate current values from updated sliders
                currentMin = document.querySelector("#minThreshold").value;
                currentMax = document.querySelector("#maxThreshold").value;

                // Update the displayed values
                document.querySelector("#minThresholdValue").textContent = currentMin;
                document.querySelector("#maxThresholdValue").textContent = currentMax;


                function draw(binCount, minThreshold, maxThreshold) {

                    const binCountNum = +binCount;
                    const minThresholdNum = +minThreshold;
                    const maxThresholdNum = +maxThreshold;

                    // /////////////////COLOR CODING (40 points)/////////////////////////////
                    const color_stops = 7;
                    // Create 7 evenly spaced stops from minValue to maxValue for the domain
                    const colorDomain = d3.range(color_stops).map(i => minValue + (maxValue - minValue) * (i / (color_stops - 1)));

                    const colors = d3.scaleLinear()
                        .domain(colorDomain) // The domain is set across the full data extent
                        .range(["#0d1a50", "#3e5eba", "#2b83ba", "#abdda4", "#ffffbf", "#fdae61", "#d7191c"]) // THE COLOR PALETTE
                        .interpolate(d3.interpolateHcl);

                    // ///////////////////////////////////////////////////////////
                    // Step 3: CONTOUR GENERATION (40 points)
                    const step = (maxThresholdNum - minThresholdNum) / binCountNum;
                    let thresholdsArray = d3.range(minThresholdNum, maxThresholdNum + step, step);

                    if (minThresholdNum === maxThresholdNum && binCountNum >= 1) {
                        thresholdsArray = [minThresholdNum];
                    }

                    let contours = d3.contours()
                        .size([m, n])
                        .thresholds(thresholdsArray) // Thresholds are controlled by the sliders
                        (values_density);


                    // Step 4: Draw the contours
                    svg.selectAll(".contours").remove();
                    svg.append("g")
                        .attr("class", "contours")
                        .selectAll("path")
                        .data(contours)
                        .enter()
                        .append("path")
                        .attr("d", function (d) { return path(d) })
                        .attr("stroke", "black")
                        .attr("stroke-width", ".1px")
                        .attr("stroke-linejoin", "round")
                        .attr("fill", d => colors(d.value)); // Color based on the contour value
                }

                draw(currentBinCount, currentMin, currentMax);

                // Event listener for all slider inputs
                document.addEventListener("input", e => {
                    const tagId = e.target.id;

                    if (tagId === "binCount" || tagId === "minThreshold" || tagId === "maxThreshold") {
                        currentBinCount = document.querySelector("#binCount").value;
                        currentMin = document.querySelector("#minThreshold").value;
                        currentMax = document.querySelector("#maxThreshold").value;

                        // Update slider value display
                        document.querySelector("#binCountValue").textContent = currentBinCount;
                        document.querySelector("#minThresholdValue").textContent = currentMin;
                        document.querySelector("#maxThresholdValue").textContent = currentMax;

                        draw(currentBinCount, currentMin, currentMax)
                    }
                })
            })
        }

        function filesList() {
            const files_data = ["brain_001.dcm.json", "brain_002.dcm.json",
                "brain_003.dcm.json", "brain_004.dcm.json",
                "brain_005.dcm.json", "brain_006.dcm.json",
                "brain_007.dcm.json", "brain_008.dcm.json",
                "brain_009.dcm.json", "brain_010.dcm.json",
                "brain_011.dcm.json", "brain_012.dcm.json",
                "brain_013.dcm.json", "brain_014.dcm.json",
                "brain_015.dcm.json", "brain_016.dcm.json",
                "brain_017.dcm.json", "brain_018.dcm.json", "brain_019.dcm.json", "brain_020.dcm.json"]
            const selectElement = d3.select("#files");
            selectElement
                .selectAll("option")
                .data(files_data)
                .enter()
                .append("option")
                .text(d => d)

            selectElement.on("change", (d) => {
                const selectedOption = selectElement.property("value");
                plot_contour(selectedOption)
            });

            selectElement.attr("size", files_data.length);
        }

        // Initial load
        filesList();
        plot_contour("brain_001.dcm.json");

    </script>
</body>

</html>